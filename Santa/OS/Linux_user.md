# Linux 用户和用户组管理

Linux 系统是一个多用户多任务的分时操作系统，任何一个要使用系统资源的用户，都必须首先向系统管理员申请一个账号，然后以这个账号的身份进入系统。

用户的账号一方面可以帮助系统管理员对使用系统的用户进行跟踪，并控制他们对系统资源的访问；另一方面也可以帮助用户组织文件，并为用户提供安全性保护。

### 用户账号

每个用户账号都拥有一个唯一的用户名和各自的口令。用户在登录时键入正确的用户名和口令后，就能够进入系统和自己的主目录。

### 用户账号管理的主要工作

实现用户账号的管理，要完成的工作主要有如下几个方面：

1. **用户账号的添加、删除与修改**
   - 添加用户账号：使用 `useradd` 命令创建新的用户账号。
   - 删除用户账号：使用 `userdel` 命令删除用户账号。
   - 修改用户账号：使用 `usermod` 命令修改用户账号的属性，例如用户名、主目录、用户组等。

2. **用户口令的管理**
   - 设置用户口令：使用 `passwd` 命令为用户设置或更改口令。
   - 锁定用户账号：使用 `passwd -l` 命令锁定用户账号，防止其登录。
   - 解锁用户账号：使用 `passwd -u` 命令解锁用户账号。

3. **用户组的管理**
   - 添加用户组：使用 `groupadd` 命令创建新的用户组。
   - 删除用户组：使用 `groupdel` 命令删除用户组。
   - 修改用户组：使用 `groupmod` 命令修改用户组的属性，例如组名等。
   - 将用户添加到用户组：使用 `usermod -aG` 命令将用户添加到指定用户组。
   - 从用户组中移除用户：使用 `gpasswd -d` 命令将用户从用户组中移除。

   以下是将你提供的关于 Linux 系统用户账号管理的内容转换为 Markdown 格式的文档，最高级别标题为 `##`：


## Linux 系统用户账号的管理

 用户账号的管理工作主要涉及到**用户账号的添加、修改和删除**

 添加用户账号就是在系统中创建一个新账号，然后为新账号**分配用户号、用户组、主目录和登录 Shell 等资源**。刚添加的账号是被锁定的，无法使用。

### 1. 添加用户账号
 添加新的用户账号使用 `useradd` 命令

` useradd 选项 用户名`


 - **选项:**
   - `-c comment`：指定一段注释性描述。
   - `-d 目录`：指定用户主目录，如果此目录不存在，则同时使用 `-m` 选项，可以创建主目录。
   - `-g 用户组`：指定用户所属的用户组。
   - `-G 用户组，用户组`：指定用户所属的附加组。
   - `-s Shell文件`：指定用户的登录 Shell。
   - `-u 用户号`：指定用户的用户号，如果同时有 `-o` 选项，则可以重复使用其他用户的标识号。

 - **用户名**：指定新账号的登录名。

实例
 ```
 # useradd -d /home/sam -m sam
 ```
 此命令创建了一个用户 `sam`，其中 `-d` 和 `-m` 选项用来为登录名 `sam` 产生一个主目录 `/home/sam`（`/home` 为默认的用户主目录所在的父目录）。

实例 2
 ```
 # useradd -s /bin/sh -g group -G adm,root gem
 ```
 此命令新建了一个用户 `gem`，该用户的登录 Shell 是 `/bin/sh`，它属于 `group` 用户组，同时又属于 `adm` 和 `root` 用户组，其中 `group` 用户组是其主组。  

 这里可能需要新建组：
 ```
 # groupadd group
 # groupadd adm
 ```

 增加用户账号就是在 `/etc/passwd` 文件中为新用户增加一条记录，同时更新其他系统文件如 `/etc/shadow`、`/etc/group` 等。  

 **Linux 提供了集成的系统管理工具 `userconf`，它可以用来对用户账号进行统一管理。**

### 2. 删除用户账号
> 如果一个用户的账号不再使用，可以从系统中删除。

>删除用户账号就是要将 `/etc/passwd` 等系统文件中的该用户记录删除，必要时还删除用户的主目录。


 删除一个已有的用户账号

` userdel 选项 用户名`

 常用的选项是 `-r`，它的作用是把用户的主目录一起删除。

示例
 ```
 # userdel -r sam
 ```
 此命令删除用户 `sam` 在系统文件中（主要是 `/etc/passwd`、`/etc/shadow`、`/etc/group` 等）的记录，同时删除用户的主目录。

### 3. 修改用户账号
>修改用户账号就是根据实际情况更改用户的有关属性，如用户号、主目录、用户组、登录 Shell 等。

 修改已有用户的信息使用 `usermod` 命令，其格式如下：

` usermod 选项 用户名`

 常用的选项包括 `-c`、`-d`、`-m`、`-g`、`-G`、`-s`、`-u` 以及 `-o` 等，意义与 `useradd` 命令中的选项一样，可以为用户指定新的资源值。  
 另外，有些系统可以使用选项 `-l 新用户名`，这个选项指定一个新的账号，即将原来的用户名改为新的用户名。

#### 示例
 ```
 # usermod -s /bin/ksh -d /home/z -g developer sam
 ```
 此命令将用户 `sam` 的登录 Shell 修改为 `ksh`，主目录改为 `/home/z`，用户组改为 `developer`。

### 4. 用户口令的管理
>用户管理的一项重要内容是用户口令的管理。用户账号刚创建时没有口令，但是被系统锁定，无法使用，必须为其指定口令后才可以使用，即使是指定空口令。

 指定和修改用户口令的 Shell 命令是 `passwd`。超级用户可以为自己和其他用户指定口令，普通用户只能用它修改自己的口令。

` passwd 选项 用户名`

 可使用的选项：
 - `-l`：锁定口令，即禁用账号。
 - `-u`：口令解锁。
 - `-d`：使账号无口令。
 - `-f`：强迫用户下次登录时修改口令。

 如果未指定用户名，则修改当前用户的口令。

#### 示例
 假设当前用户是 `sam`，则下面的命令修改该用户自己的口令：
 ```
 $ passwd
 Old password:******
 New password:*******
 Re-enter new password:*******
 ```

 如果是超级用户，可以用下列形式指定任何用户的口令：
 ```
 # passwd sam
 New password:*******
 Re-enter new password:*******
 ```

 普通用户修改自己的口令时，`passwd` 命令会先询问原口令，验证后再要求用户输入两遍新口令，如果两次输入的口令一致，则将这个口令指定给用户；而**超级用户为用户指定口令时，就不需要知道原口令**

#### 安全建议
 为了系统安全起见，用户应该选择比较复杂的口令，例如最好使用 8 位长的口令，口令中包含大写、小写字母和数字，并且应该与姓名、生日等不相同。

#### 为用户指定空口令

` # passwd -d sam`

 此命令将用户 `sam` 的口令删除，这样用户 `sam` 下一次登录时，系统就不再允许该用户登录了。

#### 锁定用户账号

` # passwd -l sam`

 此命令锁定用户 `sam` 的账号，使其无法登录。

***

 ## 二、Linux 系统用户组的管理

 >每个用户都有一个用户组，系统可以对一个用户组中的所有用户进行集中管理。不同 Linux 系统对用户组的规定有所不同，例如 Linux 下的用户属于与它同名的用户组，这个用户组在创建用户时同时创建。

 用户组的管理涉及用户组的添加、删除和修改，这些操作实际上是对 `/etc/group` 文件的更新。

 ### 1. 增加用户组

>增加一个新的用户组使用 `groupadd` 命令。

` groupadd 选项 用户组`

 - `-g GID`：指定新用户组的组标识号（GID）。
 - `-o`：一般与 `-g` 选项同时使用，表示新用户组的 GID 可以与系统已有用户组的 GID 相同。

示例 1
 ```
 # groupadd group1
 ```
 此命令向系统中增加了一个新组 `group1`，新组的组标识号是在当前已有的**最大组标识号的基础上加 1**。

示例 2
 ```
 # groupadd -g 101 group2
 ```

 此命令向系统中增加了一个新组 `group2`，同时**指定新组的组标识号是 101**。

 ### 2. 删除用户组

>如果要删除一个已有的用户组，使用 `groupdel` 命令

` groupdel 用户组`

示例
 ```
 # groupdel group1
 ```
 此命令从系统中删除组 `group1`。

 ### 3. 修改用户组属性
>修改用户组的属性使用 `groupmod` 命令。

` groupmod 选项 用户组`


 - `-g GID`：为用户组指定新的组标识号。
 - `-o`：与 `-g` 选项同时使用，用户组的新 GID 可以与系统已有用户组的 GID 相同。
 - `-n 新用户组`：将用户组的名字改为新名字。

示例 1
 ```
 # groupmod -g 102 group2
 ```

 此命令将组 `group2` 的组标识号修改为 102。

示例 2
 ```
 # groupmod -g 10000 -n group3 group2
 ```
 此命令将组 `group2` 的标识号改为 10000，组名修改为 `group3`。

 ### 4. 用户组切换
 >如果一个用户同时属于多个用户组，那么用户可以在用户组之间切换，以便具有其他用户组的权限。

 **用户可以在登录后**，使用命令 `newgrp` 切换到其他用户组，这个命令的参数就是目标用户组。

示例
 ```
 $ newgrp root
 ```

 这条命令将当前用户切换到 `root` 用户组，前提是 `root` 用户组确实是**该用户的主组或附加组**。类似于用户账号的管理，用户组的管理也可以通过集成的系统管理工具来完成。

***

 ## 三、与用户账号有关的系统文件

 完成用户管理的工作有许多种方法，但每一种方法实际上都是对有关的系统文件进行修改。与用户和用户组相关的信息都存放在一些系统文件中，这些文件包括 `/etc/passwd`、`/etc/shadow` 和 `/etc/group` 等。

 ### 1. `/etc/passwd` 文件
 `/etc/passwd` 文件是用户管理工作涉及的最重要的一个文件。Linux 系统中的每个用户在 `/etc/passwd` 文件中都有一个对应的记录行，它记录了这个用户的一些基本属性。这个文件对所有用户都是可读的。

 #### 文件格式
 每行记录被冒号 (`:`) 分隔为 7 个字段，格式如下：

` 用户名:口令:用户标识号:组标识号:注释性描述:主目录:登录Shell`


 #### 字段含义：
 1. **用户名**：代表用户账号的字符串，通常长度不超过 8 个字符，由大小写字母和/或数字组成。
 2. **口令**：一些系统中存放加密后的用户口令字。现代 Linux 系统通常将加密后的口令存放在 `/etc/shadow` 文件中，而 `/etc/passwd` 文件的口令字段中只存放一个特殊的字符（如 `x` 或 `*`）。
 3. **用户标识号**：一个整数，系统内部用它来标识用户。通常取值范围是 0～65535，其中 0 是超级用户 `root` 的标识号，普通用户的标识号从 100 或 500 开始。
 4. **组标识号**：记录用户所属的用户组，对应 `/etc/group` 文件中的一条记录。
 5. **注释性描述**：记录用户的一些个人情况，如真实姓名、电话、地址等。在许多 Linux 系统中，这个字段存放的是一段任意的注释性描述文字。
 6. **主目录**：用户的起始工作目录，通常是 `/home/用户名`。
 7. **登录 Shell**：用户登录后运行的命令解释器或特定程序。常用的 Shell 包括 `sh`、`bash`、`csh`、`ksh` 等。

 #### 示例
 ```
 # cat /etc/passwd
 root:x:0:0:Superuser:/:
 daemon:x:1:1:System daemons:/etc:
 bin:x:2:2:Owner of system commands:/bin:
 sys:x:3:3:Owner of system files:/usr/sys:
 adm:x:4:4:System accounting:/usr/adm:
 uucp:x:5:5:UUCP administrator:/usr/lib/uucp:
 auth:x:7:21:Authentication administrator:/tcb/files/auth:
 cron:x:9:16:Cron daemon:/usr/spool/cron:
 listen:x:37:4:Network daemon:/usr/net/nls:
 lp:x:71:18:Printer administrator:/usr/spool/lp:
 sam:x:200:50:Sam san:/home/sam:/bin/sh   // 用户名:口令:用户标识号:组标识号:注释性描述:主目录:登录Shell
 ```

 ### 2. `/etc/shadow` 文件
 `/etc/shadow` 文件用于存储加密后的用户口令字，只有超级用户才有权限读取该文件，从而保证用户密码的安全性。`/etc/shadow` 文件中的记录行与 `/etc/passwd` 文件一一对应。

 #### 文件格式

 每行记录被冒号 (`:`) 分隔为多个字段，格式如下：
 ```
 登录名:加密口令:最后一次修改时间:最小时间间隔:最大时间间隔:警告时间:不活动时间:失效时间:标志
 ```

 #### 字段含义：
 1. **登录名**：与 `/etc/passwd` 文件中的登录名一致。
 2. **加密口令**：长度为 13 个字符的加密口令。如果为空，则用户没有口令；如果包含特殊字符，则用户不能登录。
 3. **最后一次修改时间**：从某个时刻起，到用户最后一次修改口令时的天数。
 4. **最小时间间隔**：两次修改口令之间所需的最小天数。
 5. **最大时间间隔**：口令保持有效的最大天数。
 6. **警告时间**：从系统开始警告用户到用户密码正式失效之间的天数。
 7. **不活动时间**：用户没有登录活动但账号仍能保持有效的最大天数。
 8. **失效时间**：账号的生存期，期满后账号失效。

 #### 示例
 ```
 # cat /etc/shadow
 root:Dnakfw28zf38w:8764:0:168:7:::
 daemon:*::0:0::::
 bin:*::0:0::::
 sys:*::0:0::::
 adm:*::0:0::::
 uucp:*::0:0::::
 nuucp:*::0:0::::
 auth:*::0:0::::
 cron:*::0:0::::
 listen:*::0:0::::
 lp:*::0:0::::
 sam:EkdiSECLWPdSa:9740:0:0::::   // 登录名:加密口令:最后一次修改时间:最小时间间隔:最大时间间隔:警告时间:不活动时间:失效时间:标志
 ```

 ### 3. `/etc/group` 文件

 用户组的所有信息都存放在 `/etc/group` 文件中。此文件的格式类似于 `/etc/passwd` 文件，由冒号 (`:`) 分隔为多个字段，格式如下：

 ```
 组名:口令:组标识号:组内用户列表
 ```

 #### 字段含义：
 1. **组名**：用户组的名称，由字母或数字构成。
 2. **口令**：用户组加密后的口令字。一般 Linux 系统的用户组没有口令，该字段为空或为 `*`。
 3. **组标识号**：一个整数，系统内部用它来标识组。
 4. **组内用户列表**：属于该组的所有用户，不同用户之间用逗号 (`,`) 分隔。

 #### 示例
 ```bash
 # cat /etc/group
 root::0:root
 bin::2:root,bin
 sys::3:root,uucp
 adm::4:root,adm
 daemon::5:root,daemon
 lp::7:root,lp
 users::20:root,sam
 ```

 ## 四、添加批量用户

 >添加和删除用户对每位 Linux 系统管理员都是轻而易举的事，但如果要添加几十个、上百个甚至上千个用户时，使用 `useradd` 一个一个地添加显然不现实。Linux 系统提供了批量创建用户的工具，可以快速创建大量用户。


 ### 1. 编辑用户文件
 先编辑一个文本用户文件，每一列按照 `/etc/passwd` 文件的格式书写。注意每个用户的用户名、UID、宿主目录都不可以相同，密码栏可以留空或输入 `x`。例如，文件 `user.txt` 内容如下：

 ```
 user001::600:100:user:/home/user001:/bin/bash
 user002::601:100:user:/home/user002:/bin/bash
 user003::602:100:user:/home/user003:/bin/bash
 user004::603:100:user:/home/user004:/bin/bash
 user005::604:100:user:/home/user005:/bin/bash
 user006::605:100:user:/home/user006:/bin/bash
 ```

 ### 2. 创建用户

 以 `root` 身份执行命令 `/usr/sbin/newusers`，从用户文件中导入数据并创建用户：

 ```
 # newusers < user.txt
 ```
 然后可以执行命令 `vipw` 或 `vi /etc/passwd` 检查 `/etc/passwd` 文件是否已经出现这些用户的数据，并且用户的宿主目录是否已经创建。

 ### 3. 取消 Shadow Password 功能

 执行命令 `/usr/sbin/pwunconv`，将 `/etc/shadow` 产生的 shadow 密码解码，然后回写到 `/etc/passwd` 中，并将 `/etc/shadow` 的 shadow 密码栏删掉。这是为了方便下一步的密码转换工作：

 ```
 # pwunconv
 ```

 ### 4. 编辑密码对照文件

 编辑每个用户的密码对照文件，格式为：
 ```
 用户名:密码
 ```
 例如，文件 `passwd.txt` 内容如下：
 ```bash
 user001:123456
 user002:123456
 user003:123456
 user004:123456
 user005:123456
 user006:123456
 ```

 ### 5. 设置用户密码
 以 `root` 身份执行命令 `/usr/sbin/chpasswd`，创建用户密码：
 ```
 # chpasswd < passwd.txt
 ```
 `chpasswd` 会将经过 `/usr/bin/passwd` 命令编码过的密码写入 `/etc/passwd` 的密码栏。

 ### 6. 启用 Shadow Password 功能

 确定密码经编码写入 `/etc/passwd` 的密码栏后，执行命令 `/usr/sbin/pwconv` 将密码编码为 shadow password，并将结果写入 `/etc/shadow`：
 ```
 # pwconv
 ```

 完成以上步骤后，可以到 `/home` 下检查这些用户宿主目录的权限设置是否正确，并登录验证用户密码是否正确。
