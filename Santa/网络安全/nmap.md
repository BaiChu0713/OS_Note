# nmap用法介绍

- 端口扫描

  - 指定端口 -p
  - 指定扫描方式

- 主机探测

- 服务识别

- 系统识别

- 结果导出

## 端口扫描

-  `nmap 192.168.1.2`

直接扫描主机(192.168.1.2)的开放端口，默认扫描1000个端口

- `-p`

### 指定扫描端口
    `-p 80`
    `-p 1-80`
    `-p 80,3389,22,21`扫描80、3389、22、21端口
    `-p-`相当于1-65535

#### 补充：端口

IP 地址：相当于房子的街道地址（例如：北京市海淀区XX路XX号）。它唯一地标识了网络上的哪一台计算机。

端口号：相当于房子里的房间号（例如：201房、808房）它标识了这台计算机上运行的哪一个具体的应用程序或服务

0-1023： 知名端口，分配给系统最重要、最通用的服务（如HTTP、FTP）。

1024-49151： 注册端口，分配给一些公司或机构的商用软件服务。

49152-65535： 动态/私有端口，通常用于客户端的临时连接，或者一些非标准服务。



       **TCP** 端口：需要先建立连接，确保对方能听到，并且会确认信息是否收到。**可靠，但稍慢**。适用于要求准确性的场景。
       **UDP** 端口：直接发送出去，不建立连接，也不关心对方是否收到。**快速，但不可靠。** 适用于要求实时性的场景。

一个端口号就像是一个门牌号，但**TCP和UDP是这个门牌号的两扇不同的门**。服务可以只开TCP的门，也可以只开UDP的门，或者两扇门都开。


| 端口号 | 服务 | 主要协议 | 原因解释 |
    | :--- | :--- | :--- | :--- |
    | **80, 443** | HTTP, HTTPS | **TCP** | 网页传输要求数据完整、准确，不能丢失或错乱。 |
    | **22** | SSH | **TCP** | 远程管理需要稳定的、有序的数据流，确保命令准确执行。 |
    | **3389** | RDP | **TCP** | 图形化桌面传输需要稳定的连接，保证显示和操作不中断。 |
    | **21** | FTP (控制) | **TCP** | 发送控制指令（如登录、切换目录）需要可靠连接。 |
    | **20** | FTP (数据) | **TCP** | 文件传输本身必须保证数据完整，不能出错。 |
    | **25, 110, 143** | SMTP, POP3, IMAP | **TCP** | 电子邮件不能丢失或乱序，必须可靠传输。 |
    | **53** | DNS | **TCP 和 UDP** | **这是最典型的双重协议端口。** <br> • **UDP**：用于普通的**域名解析查询**，因为它速度快。一个请求一个回复，很简单。<br> • **TCP**：当返回的DNS响应数据太大（如区域传输），或者需要可靠连接时（如DNSSEC），就会使用TCP。 |
    | **123** | NTP | **UDP** | 时间同步要求实时性，偶尔丢失一个时间包没关系，下一个很快就会来。 |
    | **161** | SNMP | **UDP** | 网络设备监控信息通常是周期性的、小量的数据，实时性比可靠性更重要。 |
    | **445, 139, 135** | SMB | **TCP** | 文件共享和远程过程调用需要可靠的连接来保证数据一致性。 |

**绝大多数面向连接的服务（网页、邮件、远程桌面、文件传输）都使用TCP。**

**绝大多数面向查询、实时性要求高的服务（DNS查询、时间同步、视频流）主要使用UDP。**

**关键端口如53，需要同时考虑其在TCP和UDP上的安全风险。**

### 指定扫描方式

  - `-sT` TCP全连接扫描
    > s(scan) T(TCP)

    `-p 80 -sT`  指定80端口，采用完整的三次握手建立连接判断是否开放(STATE=open/closed?)

  -  `-sS` SYN半连接扫描

    只进行零次握手，对方返回确认帧(ACK=1)就判断端口开放

  - 隐秘扫描

核心原理：违反协议的“敲门测试”

标准的三次握手是基于 **SYN** 包的。而隐秘扫描的核心思想是：**发送一个不符合正常TCP通信规则的、异常的TCP数据包，然后通过观察对方的反应来判断端口状态。**

根据 **RFC 793** 的规定，如果一个TCP数据包到达了一个**关闭**的端口，主机必须回应一个 **RST**（复位）包来重置这个连接。而如果数据包到达了一个**开放**的端口，主机会直接**丢弃**这个不符合规范的数据包，不做任何响应。

隐秘扫描正是利用了开放端口和关闭端口在**行为上的这种差异**。


#### 1. FIN 扫描
*   **命令**： `nmap -sF <target>`
*   **发送的包**： 一个只设置了 **FIN** 标志位的数据包。
*   **工作原理**：
  *   在正常的TCP通信中，**FIN** 包用于优雅地终止一个已建立的连接。在一个新连接的开始就收到FIN包是**极其异常**的。
  *   **如果端口关闭**： 目标主机会认为这是个错误，于是回复一个 **RST** 包。Nmap看到RST，就判定端口为 **closed**。
  *   **如果端口开放**： 目标主机的协议栈会默默地丢弃这个不合逻辑的包，**不作任何回复**。Nmap收不到响应，无法区分是“端口开放”还是“防火墙丢弃了包”，所以判定端口为 **open|filtered**（开放或被过滤）。

#### 2. Null 扫描
*   **命令**： `nmap -sN <target>`
*   **发送的包**： 一个**所有标志位都为0**的TCP数据包。这是一个“空包”，没有任何意义。
*   **工作原理**：
  *   这种包在TCP协议中是完全无效的。
  *   **如果端口关闭**： 目标主机回复 **RST**。
  *   **如果端口开放**： 目标主机丢弃该包，**无响应**。状态判定为 **open|filtered**。


#### 3. Xmas 扫描
*   **命令**： `nmap -sX <target>`
*   **发送的包**： 一个设置了 **FIN**, **PSH**, **URG** 标志位的数据包。这就像一棵所有灯都亮起的圣诞树，故名“Xmas tree包”。
*   **工作原理**：
  *   同时设置这些标志位在现实中极为罕见，同样是一个异常包。
  *   **如果端口关闭**： 目标主机回复 **RST**。
  *   **如果端口开放**： 目标主机丢弃该包，**无响应**。状态判定为 **open|filtered**。


优势（为什么叫“隐秘”？）

1.  **绕过基本防火墙**： 许多简单的包过滤防火墙和入侵检测系统规则只检测常见的 **SYN** 包。这些异常的FIN/Null/Xmas包可能会被当作无关流量而放行，从而探测到防火墙后的端口状态。
2.  **不留连接记录**： 由于从未发起SYN请求，这些扫描不会在目标系统的应用层日志中建立连接记录，比 `-sT` 和 `-sS` 更隐蔽。


| 扫描类型 | 发送包特征 | 关闭端口响应 | 开放端口响应 | 判定结果（无响应时） | 主要目标系统 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **FIN (-sF)** | FIN=1 | RST | 无响应 | `open|filtered` | Linux, BSD 等 |
| **Null (-sN)** | 所有标志=0 | RST | 无响应 | `open|filtered` | Linux, BSD 等 |
| **Xmas (-sX)** | FIN, PSH, URG=1 | RST | 无响应 | `open|filtered` | Linux, BSD 等 |


#### 补充：TCP建立连接

|Step|方向|状态描述|发送的标志位|序列号|确认号|含义|
|-|-|-|-|-|-|-|
|1|C->S|客户端发送连接请求|SYN=1|seq=x|-|我想建立连接，我的序列号是x|
|||客户端状态|SYN-SENT|||（客户端进入同步已发送状态）|
|2|S->C|服务器确认并回复请求|SYN=1,ACK=1|seq=y|ack=x+1|我同意连接，我的初始序列号是 y，我收到了你的 x|
|||服务器状态|SYN-RCVD|||服务器进入同步已收到状态|
|3|C->S|客户端确认服务器的回应|ACK=1|seq=x+1|ack=y+1|好的，我也收到了你的 y，我们可以开始通信了|
|||双方状态|ESTABLISHED|||		（双方都进入连接已建立状态，可以传输数据）|



|||
|-|-|
|序列号|`seq`|这是 TCP 为每个数据字节分配的编号，用于**保证数据的有序性和可靠性**。在握手阶段，双方交换各自的**初始序列号**，为后续的数据传输奠定基础。|
|确认号|`ack`|这是期望收到的**下一个字节的序列号**。它告诉对方：“我已经成功收到了 `ack - 1` 之前的所有数据”。因此，`ack = 对方的上一个seq + 1`|

|标志位||
|-|-|
|SYN 同步标志|用于建立连接，并同步序列号|
|ACK 确认标志|表示确认号字段是有效的。一旦连接建立，ACK 通常在整个通信过程中都设置为 1|

## 主机探测

`-sP` scan Port

不扫描端口，只扫描「存活主机」。

本质上是Ping扫描，能Ping通有回包，就判定主机在线

`nmap -sP 192.168.31.0/24`

## 服务识别

`-sV` scan version

识别具体的服务版本

`nmap 192.168.1.4 -p 80 -sV`

## 系统识别

`-O` Operating System

`nmap 192.168.1.3 -p 80 -O`

## 扫描结果导出

`-o`output

`-oN`导出为文本格式

`nmap 192.168.1.1 -p 80 -oN echo.txt`

`-oX`导出为xml格式

`nmap 192.168.1.1 -p 80 -oN echo.xml`
